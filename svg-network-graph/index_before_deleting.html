<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Drawing network graphs with SVG</title>
    <link rel="stylesheet" type="text/css" href="style.css">

<style>

    body, html {
        font-family: sans-serif;
        color: #000a12;
        margin: 0;
        padding: 0;
    }

    .hide {
        display: none;
    }

    .show {
        display: inline-block;
    }



    .gray-bg {
        /*background-color: #eceff1;*/
    }

    .wrapper {
        display: flex;
    }

    #canvas-container{
        width: 50vw;
        height: 100vh;
        margin: 0;
    }

    #controls-container{
        background-color: #ffab91;
        box-sizing: border-box;
        border-left: 10px solid #ff7043;
        width: 50vw;
        margin: 0;
        padding: 1.5em;
    }

</style>

</head>

<body>
    <div class="wrapper">
        <div id="canvas-container">
        </div>
        <div id="controls-container">
            <h1>Mutual influence among people influenced by x</h1>
            <p>This graph shows patterns of influence among people who have been influenced by a given figure, according to wikidata. Direction of influence is, for now, shown by highlighting -- if you hover over the person who's been influenced, it will highlight links to the people who influenced them. (At least, I think that's what it shows? I spent most of my time trying to wrangle the data into the right format, so haven't properly checked that the query yields what I want it to, yet...</p>
            <form>
                <input id="searchId" value="Q868"></form>
                <br>
                <button id="searchButton">graph it</button>
            </form>
            <p>Search by wikidata id, for now. Some suggestions:</p>
            <ul>
                <li>Aristotle -- Q868</li>
                <li>Plato -- Q859 </li>
                <li>Wittgenstein -- Q9391</li>
                <li>Elizabeth Anscombe -- Q229646</li>
                <li>Simone de Beauvoir -- Q7197</li>
                <li>Shakespeare -- Q692</li>
                <li>Jesus -- Q254322</li>
                <li>Ella Fitzgerald -- Q1768</li>
            </ul>
            <p>Haven't found it easy to find women with interesting graphs for this yet :-/</p>
        </div>
    </div>
</body>
<script src="drawing-functions.js"></script>
<script src="network-functions.js"></script>
<script>
    var vWidth = window.innerWidth;
    var vHeight = window.innerHeight;
    var net = {};

    var ns = 'http://www.w3.org/2000/svg';
    var div = document.getElementById('canvas-container'); 
    var svg = document.createElementNS(ns, 'svg');
    svg.setAttributeNS(null, 'width', '100%');
    svg.setAttributeNS(null, 'height', '100%');
    svg.setAttributeNS(null, 'id', 'graph-svg');
    svg.setAttributeNS(null, 'class', 'gray-bg');
    div.appendChild(svg);
    var searchButton = document.getElementById('searchButton');
    searchButton.addEventListener('click', searchAndGraph);

    // let net = generateRandomNetwork(15, 0.1);
    // arrangeInCircle(net.nodes, 300, 300, 250);
    // drawGraph(net.edges, net.nodes, 'graph-svg');

function findLinks(targetId, nodeMaps){

    //the idea is that 'targetNode' will be the id of a node, and that nodeMaps will be an object with keys representing each of the other nodes, and values representing the nodes which the former are attached to. It outputs an array of edges, in the format that I'm using here.
    let edgeList = [];
    
    for (const id of Object.keys(nodeMaps)) {
        if(nodeMaps[id].influencedBy.includes(targetId)){
            edgeList.push({'source' : id, 'target' : targetId, 'color' : ''});
        }
    }

    return edgeList;
}

class SPARQLQueryDispatcher {
    constructor( endpoint ) {
        this.endpoint = endpoint;
    }

    query( sparqlQuery ) {
        const fullUrl = this.endpoint + '?query=' + encodeURIComponent( sparqlQuery );
        const headers = { 'Accept': 'application/sparql-results+json' };

        return fetch( fullUrl, { headers } ).then( body => body.json() );
    }
}

const endpointUrl = 'https://query.wikidata.org/sparql';
const sparqlQuery1 = `
SELECT ?item ?itemLabel ?influenced_by ?influenced_byLabel WHERE {
  ?item wdt:P737 wd:`;

const sparqlQuery2 = `.
                  SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }
                  OPTIONAL { ?item wdt:P737 ?influenced_by. }
                }`;
const queryDispatcher = new SPARQLQueryDispatcher( endpointUrl );


function idFromURI(ur){
    return ur.replace("http://www.wikidata.org/entity/", "");
}

function searchAndGraph(){

    sparqlId = document.getElementById('searchId').value;

    queryDispatcher.query( sparqlQuery1 + sparqlId + sparqlQuery2 ).then( 
        function(response) {
            let bin = response.results.bindings;
            let idList = {};
            let nodeList = [];
            let edgeList = [];
            for (entry of bin){
                let id = idFromURI(entry.item.value);
                let label = idFromURI(entry.itemLabel.value);
                let influenceBy = idFromURI(entry.influenced_by.value);
                if (! Object.keys(idList).includes(id)) {
                    idList[id] = {'label' : label, 'influencedBy' : [influenceBy]};
                } else {
                    idList[id]['influencedBy'].push(influenceBy);
                }
            }
            for (entry of Object.keys(idList)){
                nodeList.push(new graphNode(entry, idList[entry].label));
                for (link of findLinks(entry, idList)){
                    edgeList.push(link);
                }
                // edgeList.push(findLinks(entry, idList));
            }
            // console.log(nodeList);
            console.log(edgeList);
            // console.log(idList);

            // console.log(findLinks('Q868', idList));
            arrangeInCircle(
                                nodeList,
                                (vWidth/4),
                                (vHeight/2),
                                vWidth/2 < vHeight ? (vWidth/4-20) : (vHeight/2-20)
                            );
            console.log(nodeList);
            drawGraph(edgeList, nodeList, 'graph-svg');
            net = {'nodes' : nodeList, 'edges' : edgeList};
        }
    );
}



//     function prepareName(name){
//         return name.trim().replace(' ', '%20')
//     }

//     // var targ = {'12' : ['j', 'k', 'l']};
//     // var ns = {'j' : ['12'], 'k' : ['12'], 'l' : ['m']};
//     // var links = findUndirectedLinks(targ, ns);           
         

//     class SPARQLQueryDispatcher {
//         constructor( endpoint ) {
//             this.endpoint = endpoint;
//         }

//         query( sparqlQuery ) {
//             const fullUrl = this.endpoint + '?query=' + encodeURIComponent( sparqlQuery );
//             const headers = { 'Accept': 'application/sparql-results+json' };

//             return fetch( fullUrl, { headers } ).then( body => body.json() );
//         }
//     }

//     var newNodesList = [];
//     const endpointUrl = 'https://query.wikidata.org/sparql';
//     const sparqlQueryPt1 = `SELECT ?item ?itemLabel WHERE {
//                   ?item wdt:P737 wd:`;
//     const sparqlQueryPt2 = `.
//                   SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }
//                 }`;
//     const mainTargetId = `Q859`;
//     const queryDispatcher = new SPARQLQueryDispatcher( endpointUrl );
//     queryDispatcher.query( sparqlQueryPt1 + mainTargetId + sparqlQueryPt2 ).then( 
//         function(response) {
//                             let bindings = response.results.bindings;
//                             bindings.forEach((e) => newNodesList.push(
//                                 new graphNode(
//                                 e.item.value.replace("http://www.wikidata.org/entity/", ""),
//                                 e.itemLabel.value
//                                 )
//                                 ));
//                             arrangeInCircle(newNodesList, 300, 300, 250);
//                             console.log(document.getElementById('graph-svg'));
//                             drawGraph([], newNodesList, 'graph-svg');
//                             console.log(newNodesList);
//                         } );
//     var targetObject = {};
//     var targetId = "Q130631";
//     sQ2 = sparqlQueryPt1 + targetId + sparqlQueryPt2;
//     queryDispatcher.query( sQ2 ).then( 
//         function(response) {
//             var bindings = response.results.bindings;
//             var outLinks = [];
//             var firstOrderLinkList = {};
//             bindings.forEach((e) => outLinks.push(e.item.value.replace("http://www.wikidata.org/entity/", "")
//                 ));
//             targetObject[targetId] = outLinks;
//             console.log('to');
//             console.log(targetObject);

//             for (objectId of targetObject[targetId]){
//                 console.log("oId: " + objectId)
//                 let links = [];
//                 queryDispatcher.query(sparqlQueryPt1 + objectId + sparqlQueryPt2).then(
//                     function(response) {
//                         let bin = response.results.bindings;
//                         for (let i = 0; i < bin.length; i++){
//                             links.push(bin[i].item.value);
//                         }
//                         // response.results.bindings.forEach(
//                         //     (e) => 
//                         //     console.log(e.item.value)
//                         //     // links.push(e.item.value.replace("http://www.wikidata.org/entity/", ""))
//                         //     );
//                         // links.push("yolo");
//                         firstOrderLinkList[objectId] = links;        
//                     }
//                 );
//             }

// //
// //              WRITE the loop as a separate function that returns an array, and do fOLL = await f(params) ???
// //              also it looks like forEach doesn't work in a simple way with async
// //

//                 console.log("ll");
//                 console.log(firstOrderLinkList);
//         }
//     );

</script>


</html>