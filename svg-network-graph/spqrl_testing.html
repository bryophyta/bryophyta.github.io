<script src="network-functions.js"></script>
<script>
function findLinks(targetId, nodeMaps){

    //the idea is that 'targetNode' will be the id of a node, and that nodeMaps will be an object with keys representing each of the other nodes, and values representing the nodes which the former are attached to. It outputs an array of edges, in the format that I'm using here.
    let edgeList = [];
    
    for (const id of Object.keys(nodeMaps)) {
        if(nodeMaps[id].influencedBy.includes(targetId)){
            edgeList.push({'source' : id, 'target' : targetId});
        }
    }

    return edgeList;
}

class SPARQLQueryDispatcher {
	constructor( endpoint ) {
		this.endpoint = endpoint;
	}

	query( sparqlQuery ) {
		const fullUrl = this.endpoint + '?query=' + encodeURIComponent( sparqlQuery );
		const headers = { 'Accept': 'application/sparql-results+json' };

		return fetch( fullUrl, { headers } ).then( body => body.json() );
	}
}

const endpointUrl = 'https://query.wikidata.org/sparql';
const sparqlQuery = `#Cats
SELECT ?item ?itemLabel ?influenced_by ?influenced_byLabel WHERE {
  ?item wdt:P737 wd:Q868.
  SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }
  OPTIONAL { ?item wdt:P737 ?influenced_by. }
}`;

function idFromURI(ur){
	return ur.replace("http://www.wikidata.org/entity/", "");
}

const queryDispatcher = new SPARQLQueryDispatcher( endpointUrl );
queryDispatcher.query( sparqlQuery ).then( 
	function(response) {
		let bin = response.results.bindings;
		let idList = {};
		let nodeList = [];
		let edgeList = [];
		for (entry of bin){
			let id = idFromURI(entry.item.value);
			let label = idFromURI(entry.itemLabel.value);
			let influenceBy = idFromURI(entry.influenced_by.value);
			if (! Object.keys(idList).includes(id)) {
				idList[id] = {'label' : label, 'influencedBy' : [influenceBy]};
			} else {
				idList[id]['influencedBy'].push(influenceBy);
			}
		}
		for (entry of Object.keys(idList)){
			nodeList.push(new graphNode(entry, idList[entry].label));
			edgeList.push(findLinks(entry, idList));
		}
		// console.log(nodeList);
		console.log(edgeList);
		// console.log(idList);

		// console.log(findLinks('Q868', idList));
		arrangeInCircle(nodeList);
		
		return {'nodes' : nodeList, 'edges' : edgeList};
	}
);

</script>